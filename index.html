<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1, user-scalable=no">
    <title>Baldosa: the cloud city</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Open+Sans:wght@300..800&display=swap" rel="stylesheet">
    <style>
      html, body {
        margin:0; padding:0; overflow:hidden; height:100%; width:100%;
        background: #000; color: #fff;
        * {
          font-family: "Open Sans", sans-serif;
        }
      }
    </style>
  </head>
  <body>
    <infinite-grid></infinite-grid>
    <footer>
      <pan-indicator camera="camera-control"></pan-indicator>
      <zoom-indicator camera="camera-control"></zoom-indicator>
      <camera-control target="infinite-grid"></camera-control>
    </footer>
    <script type="module">
      import './client/render/grid.js'
      import './client/control/camera-control.js'
      import './client/control/pan-indicator.js'
      import './client/control/zoom-indicator.js'

      import { createGallery } from './client/render/image/gallery.js'
      import { createRepository } from './client/data/repo.js'

      const repo = createRepository()
      
      const wmin = Math.min(window.innerWidth, window.innerHeight)
      const wmax = Math.max(window.innerWidth, window.innerHeight)
      const SMALL_DEVICE = wmax <= 800
      const MIN_SCALE = SMALL_DEVICE ? wmin / 4 : wmin / 5
      const MAX_SCALE = 300

      const IMG_CACHE_SIZE = (Math.ceil(wmin / MIN_SCALE) + 4) * (Math.ceil(wmax / MIN_SCALE) + 4) * 2
      const gallery = createGallery(IMG_CACHE_SIZE)
      
      let scale = SMALL_DEVICE ? Math.min(wmin / 2.5, MAX_SCALE) : Math.min(wmin / 3.5, MAX_SCALE)

      const grid = document.querySelector('infinite-grid')
      grid.setAttribute('zoom', scale)
      grid.setProperty('repo', repo)
      grid.setProperty('gallery', gallery)

      const camera = document.querySelector('camera-control')
      camera.setAttribute('camx', .5)
      camera.setAttribute('camy', .5)
      camera.setAttribute('zoom', scale)
      camera.setAttribute('minzoom', MIN_SCALE)
      camera.setAttribute('maxzoom', MAX_SCALE)
      camera.addEventListener('pan', ({ detail }) => {
        grid.setAttribute('camx', detail.camera.x)
        grid.setAttribute('camy', detail.camera.y)

        grid.setAttribute('panv', Math.sqrt(
          detail.velocity.x * detail.velocity.x
          + detail.velocity.y * detail.velocity.y
        ) / scale)
      })
      camera.addEventListener('zoom', ({ detail }) => {
        scale = detail.zoom
        grid.setAttribute('zoom', detail.zoom)
      })

      const panind = document.querySelector('pan-indicator')
      panind.addEventListener('pan', ({ detail }) => {
        camera.setAttribute('camx', detail.x + .5)
        camera.setAttribute('camy', detail.y + .5)
      })

      grid.addEventListener('tile-hover', ({ detail }) => {
        panind.setAttribute('x', detail.x)
        panind.setAttribute('y', detail.y)
      })
    </script>
  </body>
</html>
